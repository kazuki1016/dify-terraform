# AWSãƒªã‚½ãƒ¼ã‚¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€AWSä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸDifyãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ðŸ“‹ ç›®æ¬¡

- [ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—](#ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)
- [GitHub Actionsã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—](#github-actionsã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)
- [è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½](#è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½)

## ðŸ–¥ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- AWS CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»è¨­å®šæ¸ˆã¿
- Terraform ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- é©åˆ‡ãªAWSèªè¨¼æƒ…å ±ãŒè¨­å®šæ¸ˆã¿

### ä½¿ç”¨æ–¹æ³•

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (devç’°å¢ƒã€ap-northeast-1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³)
./scripts/cleanup-aws-resources.sh

# ç’°å¢ƒã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
./scripts/cleanup-aws-resources.sh staging ap-northeast-1
```

### å®Ÿè¡Œå†…å®¹

1. **Terraformãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤**
   - VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
   - EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€Elastic IP
   - NAT Gateway
   - Security Groups
   - IAMãƒ­ãƒ¼ãƒ«ã€ãƒãƒªã‚·ãƒ¼
   - S3ãƒã‚±ãƒƒãƒˆï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰â€»ã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒã‚±ãƒƒãƒˆã¯é™¤ã

2. **Secrets Managerã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   - SSHç§˜å¯†éµã®å¼·åˆ¶å‰Šé™¤
   - SSHå…¬é–‹éµã®å¼·åˆ¶å‰Šé™¤

3. **æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºèª**
   - EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
   - NAT Gateway
   - Elastic IP

## â˜ï¸ GitHub Actionsã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### æ‰‹å‹•å®Ÿè¡Œ

1. GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹
2. **Actions** ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **AWS ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—** ã‚’é¸æŠž
4. **Run workflow** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ç’°å¢ƒåã‚’å…¥åŠ› (ä¾‹: `dev`)
6. ç¢ºèªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« `yes` ã¨å…¥åŠ›
7. **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼URL

```
https://github.com/kazuki1016/dify-terraform/actions/workflows/cleanup-aws-resources.yml
```

## ðŸ”„ è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½

ãƒ¡ã‚¤ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (`create_dify_on_aws.yml`) ã«ã¯ã€**å¤±æ•—æ™‚ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½**ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### å‹•ä½œæ¡ä»¶

- Terraform Apply ãŒæˆåŠŸã—ãŸå¾Œ
- ãã®å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆAnsibleå®Ÿè¡Œãªã©ï¼‰ã§å¤±æ•—ã—ãŸå ´åˆ

### è‡ªå‹•å®Ÿè¡Œå†…å®¹

1. Terraform destroy ã‚’å®Ÿè¡Œ
2. Secrets Manager ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å¼·åˆ¶å‰Šé™¤
3. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

### å‹•ä½œãƒ•ãƒ­ãƒ¼

```mermaid
graph TB
    A[Terraform ApplyæˆåŠŸ] --> B[Ansibleå®Ÿè¡Œ]
    B --> C{æˆåŠŸ?}
    C -->|Yes| D[ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†]
    C -->|No| E[è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹]
    E --> F[Terraform Destroy]
    F --> G[Secrets Managerå‰Šé™¤]
    G --> H[ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†]
```

## âš ï¸ æ³¨æ„äº‹é …

### ä¿æŒã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹

ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã¯**å‰Šé™¤ã•ã‚Œã¾ã›ã‚“**ï¼ˆæ„å›³çš„ã«ä¿æŒï¼‰:

- **S3ãƒã‚±ãƒƒãƒˆ**: `dify-terraform-state-*`
  - ç”¨é€”: Terraformã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜
  - ç†ç”±: è¤‡æ•°ç’°å¢ƒã§å…±æœ‰ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å¿…è¦

- **DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«**: `dify-terraform-locks`
  - ç”¨é€”: Terraformã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒ­ãƒƒã‚¯ç®¡ç†
  - ç†ç”±: åŒæ™‚å®Ÿè¡Œã®é˜²æ­¢ã«å¿…è¦

### å‰Šé™¤ã®é…å»¶

ä¸€éƒ¨ã®ãƒªã‚½ãƒ¼ã‚¹ã¯å‰Šé™¤å®Œäº†ã¾ã§æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™:

- **NAT Gateway**: å‰Šé™¤ã«æœ€å¤§5åˆ†
- **Elastic IP**: ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è§£é™¤å¾Œã«å‰Šé™¤å¯èƒ½
- **Secrets Manager**: å‰Šé™¤ä¿è­·æœŸé–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ7æ—¥ï¼‰
  - ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ `--force-delete-without-recovery` ã‚’ä½¿ç”¨ã—ã¦å³åº§ã«å‰Šé™¤

### Secrets Managerã®å‰Šé™¤ä¿è­·

é€šå¸¸ã€Secrets Managerã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯å‰Šé™¤å¾Œ7æ—¥é–“ã®ä¿è­·æœŸé–“ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§**å³åº§ã«å‰Šé™¤**ã—ã¾ã™:

```bash
--force-delete-without-recovery
```

âš ï¸ **è­¦å‘Š**: ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯å³åº§ã«å‰Šé™¤ã•ã‚Œã€å¾©å…ƒã§ãã¾ã›ã‚“ã€‚

## ðŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Terraform destroy ãŒå¤±æ•—ã™ã‚‹

**åŽŸå› **: ãƒªã‚½ãƒ¼ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã«ã‚ˆã‚Šå‰Šé™¤ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹

**è§£æ±ºç­–**:
```bash
# ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
cd infra/terraform/aws
terraform refresh -var="environment=dev" -var="aws_region=ap-northeast-1"

# å†åº¦ destroy ã‚’å®Ÿè¡Œ
terraform destroy -var="environment=dev" -var="aws_region=ap-northeast-1"
```

### Secrets Manager ã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**: `InvalidRequestException: You can't delete a secret that is pending deletion.`

**è§£æ±ºç­–**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ—¢ã«å‰Šé™¤äºˆå®šã§ã™ã€‚ç„¡è¦–ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

### ãƒªã‚½ãƒ¼ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹

**åŽŸå› **: AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¡¨ç¤ºé…å»¶ã€ã¾ãŸã¯æ‰‹å‹•ã§ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹

**ç¢ºèªæ–¹æ³•**:
```bash
# EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
aws ec2 describe-instances \
  --filters "Name=tag:Environment,Values=dev" \
            "Name=tag:System,Values=Dify" \
  --region ap-northeast-1

# NAT Gatewayã®ç¢ºèª
aws ec2 describe-nat-gateways \
  --filter "Name=tag:Environment,Values=dev" \
           "Name=tag:System,Values=Dify" \
  --region ap-northeast-1
```

## ðŸ“ž ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

1. AWS CLIã®èªè¨¼æƒ…å ±ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªæ¨©é™ãŒã‚ã‚‹ã‹
3. Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ (>= 1.6.0)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ3æ—¥
