name: AWS ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: "å‰Šé™¤ã™ã‚‹ç’°å¢ƒå (dev/staging/prod)"
        required: true
        default: "dev"
      confirm_deletion:
        description: "å‰Šé™¤ã‚’ç¢ºèª (yes ã¨å…¥åŠ›ã—ã¦ãã ã•ã„)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-1

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deletion }}" != "yes" ]; then
            echo "âŒ å‰Šé™¤ãŒç¢ºèªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚'yes' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi
          echo "âœ“ å‰Šé™¤ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4

      - name: Terraform Init
        run: terraform init
        working-directory: ./infra/terraform/aws

      - name: Terraform Destroy
        run: |
          terraform destroy \
            -var="environment=${{ github.event.inputs.environment_name }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -auto-approve
        working-directory: ./infra/terraform/aws
        continue-on-error: true

      - name: Force Delete Secrets Manager Secrets
        run: |
          echo "Secrets Manager ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."

          SECRETS=(
            "dify-ssh-private-key-${{ github.event.inputs.environment_name }}"
            "dify-ssh-public-key-${{ github.event.inputs.environment_name }}"
          )

          for SECRET_NAME in "${SECRETS[@]}"; do
            echo "ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç¢ºèªä¸­: ${SECRET_NAME}"

            if aws secretsmanager describe-secret \
                --secret-id "${SECRET_NAME}" \
                --region ${{ env.AWS_REGION }} \
                &>/dev/null; then

              echo "  å‰Šé™¤ä¸­: ${SECRET_NAME}"
              aws secretsmanager delete-secret \
                  --secret-id "${SECRET_NAME}" \
                  --region ${{ env.AWS_REGION }} \
                  --force-delete-without-recovery || echo "  å‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«å‰Šé™¤æ¸ˆã¿ï¼‰"
            else
              echo "  ${SECRET_NAME} ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
            fi
          done
        continue-on-error: true

      - name: Verify Cleanup
        run: |
          echo "### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—çµæžœ ðŸ§¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=${{ github.event.inputs.environment_name }}" \
                      "Name=tag:System,Values=Dify" \
                      "Name=instance-state-name,Values=running,pending,stopping,stopped" \
            --region ${{ env.AWS_REGION }} \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)

          if [ -n "$INSTANCES" ]; then
            echo "âš ï¸ **å®Ÿè¡Œä¸­ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**: ${INSTANCES}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**: ãªã—" >> $GITHUB_STEP_SUMMARY
          fi

          # NAT Gateway ã®ç¢ºèª
          NAT_GATEWAYS=$(aws ec2 describe-nat-gateways \
            --filter "Name=tag:Environment,Values=${{ github.event.inputs.environment_name }}" \
                     "Name=tag:System,Values=Dify" \
                     "Name=state,Values=pending,available" \
            --region ${{ env.AWS_REGION }} \
            --query 'NatGateways[].NatGatewayId' \
            --output text)

          if [ -n "$NAT_GATEWAYS" ]; then
            echo "âš ï¸ **NAT Gateway**: ${NAT_GATEWAYS}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **NAT Gateway**: ãªã—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ³¨æ„äº‹é …**:" >> $GITHUB_STEP_SUMMARY
          echo "- S3ãƒã‚±ãƒƒãƒˆ \`dify-terraform-state\` ã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™ï¼ˆTerraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- å‰Šé™¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒAWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ¶ˆãˆã‚‹ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY

      - name: Output Cleanup Summary
        run: |
          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
          echo "Environment: ${{ github.event.inputs.environment_name }}"
          echo "Region: ${{ env.AWS_REGION }}"
