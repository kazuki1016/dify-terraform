name: Dify環境自動構築 (AWS)

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/aws/**'
      - 'infra/ansible/aws/**'
      - '.github/workflows/create_dify_on_aws.yml'
  workflow_dispatch:
    inputs:
      environment_name:
        description: "環境名 (dev/staging/prod)"
        required: true
        default: "dev"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: ./infra/terraform/aws
      ANSIBLE_WORKING_DIR: ./infra/ansible/aws
      AWS_REGION: ${{ github.event.inputs.aws_region || 'ap-northeast-1' }}
      ENVIRONMENT: ${{ github.event.inputs.environment_name || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -out=tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        id: tf-apply
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get Terraform Outputs
        id: tf-outputs
        run: |
          EC2_PUBLIC_IP=$(terraform output -raw ec2_public_ip)
          SECURITY_GROUP_ID=$(terraform output -raw security_group_id)

          if [ -z "$EC2_PUBLIC_IP" ] || [ -z "$SECURITY_GROUP_ID" ]; then
            echo "Error: Failed to get Terraform outputs"
            exit 1
          fi

          echo "ec2_ip=${EC2_PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "sg_id=${SECURITY_GROUP_ID}" >> $GITHUB_OUTPUT
          echo "EC2 IP: ${EC2_PUBLIC_IP}"
          echo "Security Group ID: ${SECURITY_GROUP_ID}"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get GitHub Actions Runner IP
        id: get_ip
        run: |
          IP=$(curl -s https://checkip.amazonaws.com/)
          echo "runner_ip=${IP}" >> $GITHUB_OUTPUT

      - name: Add GitHub Actions Runner IP to Security Group
        if: steps.tf-outputs.outputs.sg_id != ''
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ steps.tf-outputs.outputs.sg_id }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.get_ip.outputs.runner_ip }}/32 \
            --region ${{ env.AWS_REGION }}

      - name: Wait for EC2 Instance to be Ready
        if: steps.tf-outputs.outputs.ec2_ip != ''
        run: |
          aws ec2 wait instance-status-ok \
            --filters "Name=ip-address,Values=${{ steps.tf-outputs.outputs.ec2_ip }}" \
            --region ${{ env.AWS_REGION }}

      - name: Setup Ansible
        if: steps.tf-outputs.outputs.ec2_ip != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible python3-pip
          pip3 install ansible-core boto3 botocore
          ansible-galaxy collection install 'community.docker:<4.0.0'
          ansible-galaxy collection install amazon.aws

      - name: Retrieve SSH Key from AWS Secrets Manager
        if: steps.tf-outputs.outputs.ec2_ip != ''
        id: get_ssh_key
        run: |
          aws secretsmanager get-secret-value \
            --secret-id dify-ssh-private-key-${{ env.ENVIRONMENT }} \
            --region ${{ env.AWS_REGION }} \
            --query SecretString \
            --output text > /tmp/ssh_key.pem
          chmod 600 /tmp/ssh_key.pem

      - name: Create Ansible Inventory
        if: steps.tf-outputs.outputs.ec2_ip != ''
        run: |
          cat > hosts.ini << EOF
          [dify_servers]
          ${{ steps.tf-outputs.outputs.ec2_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=/tmp/ssh_key.pem

          [dify_servers:vars]
          ansible_python_interpreter=/usr/bin/python3
          EOF
        working-directory: ${{ env.ANSIBLE_WORKING_DIR }}

      - name: Run Ansible Playbook
        if: steps.tf-outputs.outputs.ec2_ip != ''
        run: |
          ansible-playbook -i hosts.ini playbook.yml \
            --ssh-common-args='-o StrictHostKeyChecking=no'
        working-directory: ${{ env.ANSIBLE_WORKING_DIR }}

      - name: Output Deployment Information
        run: |
          echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**EC2 Public IP:** ${{ steps.tf-outputs.outputs.ec2_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Access Dify at: http://${{ steps.tf-outputs.outputs.ec2_ip }}" >> $GITHUB_STEP_SUMMARY

      - name: Remove GitHub Actions Runner IP from Security Group
        if: always() && steps.tf-outputs.outputs.sg_id != '' && steps.get_ip.outputs.runner_ip != ''
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ steps.tf-outputs.outputs.sg_id }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.get_ip.outputs.runner_ip }}/32 \
            --region ${{ env.AWS_REGION }} || true

      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f /tmp/ssh_key.pem

      - name: Cleanup on Failure
        if: failure() && steps.tf-apply.conclusion == 'success'
        run: |
          echo "⚠️ デプロイが失敗しました。リソースのクリーンアップを開始します..."
          
          # Terraform destroy を実行
          cd ${{ env.TF_WORKING_DIR }}
          terraform destroy \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -auto-approve || echo "Terraform destroy に失敗しました"
          
          # Secrets Manager のクリーンアップ
          echo "Secrets Manager をクリーンアップ中..."
          aws secretsmanager delete-secret \
            --secret-id dify-ssh-private-key-${{ env.ENVIRONMENT }} \
            --region ${{ env.AWS_REGION }} \
            --force-delete-without-recovery 2>/dev/null || true
          
          aws secretsmanager delete-secret \
            --secret-id dify-ssh-public-key-${{ env.ENVIRONMENT }} \
            --region ${{ env.AWS_REGION }} \
            --force-delete-without-recovery 2>/dev/null || true
          
          echo "✅ クリーンアップが完了しました"
          echo ""
          echo "手動でのクリーンアップが必要な場合は、以下のワークフローを実行してください:"
          echo "https://github.com/${{ github.repository }}/actions/workflows/cleanup-aws-resources.yml"